<link rel="import" href="../../bower_components/polymer/polymer-element.html">
<script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>

<link rel="import" href="../../bower_components/paper-tabs/paper-tabs.html">
<link rel="import" href="../../bower_components/iron-pages/iron-pages.html">
<link rel="import" href="../../bower_components/paper-tabs/paper-tab.html">
<link rel="import" href="chart-calendar.html">
<link rel="import" href="chart-scatter.html">
<!-- 
`<a-timeline>` plots your dates.

`<a-timeline>` accepts an array of datetimes.
```html
<a-timeline datetimes="[[datetimes]]"></a-timeline>
```
```js
const datetimes = ['2017-08-11T14:17', '2017-08-07T16:00','2017-08-23T15:22', '2017-09-13T14:48'];
```

Edit `<a-timeline>` color using `--timeline-color` style.
```html
<style>  
  a-timeline { 
    --timeline-color: green; 
    --timeline-text-color: grey; 
  }
</style>
```

@element a-timeline
@hero hero.svg
@demo demo/index.html
-->

<dom-module id="a-timeline">
  <template>
    <style>
      :host {
        display: block;
        @apply --timeline-mixin;
        --timeline-color: var(--default-primary-color, grey);
        --timeline-text-color: var(--default-primary-color, grey);
        --timeline-main-color: var(--dark-primary-color, #4286f4);
        --timeline-light-color: var(--light-primary-color, #d6e5ff);
        --paper-tab-ink: var(--timeline-light-color, #4286f4);
        --paper-tabs-selection-bar-color: var(--timeline-main-color, #d6e5ff);
      }

      #timeline {
        width: 100%;
        height: 20%;
        min-height: 50px;
        margin-bottom: 50px;
      }

      #calendar_chart_div, #scatter_chart_div {
        width: 100%;
        /* width: 90%; 
        height: 20%; */
        /* width: 900px; 
        height: 500px; */
      }
      @media screen and (min-width: 1200px) {
        #calendar_chart_div, #scatter_chart_div {
          width: 1200px;
        }
      }
    </style>

<paper-tabs selected="{{selected}}">
  <paper-tab>Weekdays</paper-tab>
  <paper-tab>Frequency</paper-tab>
  <!-- <paper-tab>ITEM THREE</paper-tab> -->
</paper-tabs>

<iron-pages selected="{{selected}}">
  <div>
    <chart-calendar chart-main-styles="[[chartMainStyles]]" timeline-data="[[timelineData]]"></chart-calendar>        
  </div>
  <div>
      <chart-scatter chart-main-styles="[[chartMainStyles]]" timeline-data="[[timelineData]]"></chart-scatter>    
  </div>
  <!-- <div>Three</div> -->
</iron-pages>

    <div id="timeline">
      <!-- [[jsonStringify(timelineData)]] -->
      <!-- <div id="scatter_chart_div"></div>   -->
      <!-- <chart-scatter chart-main-styles="[[chartMainStyles]]" timeline-data="[[timelineData]]"></chart-scatter>    
      <chart-calendar chart-main-styles="[[chartMainStyles]]" timeline-data="[[timelineData]]"></chart-calendar>     -->
      <!-- <div id="calendar_chart_div"></div>       -->
    </div>
    <!-- <div id="timeline">
      <div id="line">            
        <template is="dom-repeat" items="[[timelineData]]">
          <details id="details" class$="[[_computeTimelineClass(hasDetails)]]" style$="[[_computeTimelineItemStyle(item)]]">
            <summary>
              <div class="text day">[[item.day]]</div>
              <div class="text month">[[item.newMonth]]</div>
            </summary>
            <template is="dom-if" if="[[hasDetails]]">
              <div class="text detail">[[item.weekday]]</div>
              <div class="text detail">[[item.time]]</div>
            </template>
          </details>
        </template>
      </div>
    </div> -->

  </template>

  <script>
    /**
    * `a-timeline`
    * A timeline to display dates
    *
    * @customElement
    * @polymer
    * @demo demo/index.html
    */
    class ATimeline extends Polymer.Element {
      static get is() { return 'a-timeline'; }
      static get observers() {
        return [
          'dataLoaded(timelineData, chartMainStyles)',
          'selChanged(selected)',
        ];
      }
      static get properties() {
        return {
          /**
          * Array of datetimes to be plotted.
          */
          selected: {
            type: Number,
            value: 0,
          },
          datetimes: {
            type: Array,
            value: null,
          },
          timelineData: {
            type: Array,
            computed: 'computeTimelineData(datetimes)',
          },          
          hostWidth: {
            type: Number,
          },
          chartMainStyles: {
            type: Object,
            computed: 'computeChartMainStyles(hostWidth)',
          },
          // calendarChartRows: {
          //   type: Array,
          //   computed: 'computeCalendarChartRows(timelineData)',
          // },
          // scatterChartRows: {
          //   type: Array,
          //   computed: 'computeScatterChartRows(timelineData)',
          // },
        };
      }

      connectedCallback() {
        super.connectedCallback();
        // console.log(window.innerWidth);
        this.set('hostWidth', this.offsetWidth);
        console.log(this.hostWidth);
      }

      selChanged(selected) {
        this.set('hostWidth', this.offsetWidth);
        console.log(this.hostWidth);
      }      

      computeChartMainStyles(hostWidth) {
        // dimensions
        const chartWidth = (hostWidth > 1200) ? 1200 : Math.round(hostWidth) - 15;
        

        //colors
        let mainColor, lightMainColor;
        if (ShadyCSS) {
          mainColor = ShadyCSS.getComputedStyleValue(this, '--timeline-main-color');
          lightMainColor = ShadyCSS.getComputedStyleValue(this, '--timeline-light-color');
        } else {
          mainColor = getComputedStyle(this).getPropertyValue('--timeline-main-color');
          lightMainColor = getComputedStyle(this).getPropertyValue('--timeline-light-color');
        }
        const dataColor = mainColor; //'#4286f4'; 
        const lightColor = lightMainColor; //'#d6e5ff';
        return { chartWidth, dataColor, lightColor };
      }

      computeTimelineData(datetimes) {
        if (!datetimes || !datetimes[0]) return;
        const timelineData = datetimes
          .map(dt => this._toDateTime(dt))
          .map((dt, index) => {
            console.log(dt)
            return {
              datetime: dt,
              weekday: this._getWeekDay(dt),
              time: this._getTime(dt),
              formattedDate: this._formattedDate(dt),
              date: this._getDate(dt),
            }
          });
        return timelineData;        
      }

      // dataLoaded(timelineData, chartMainStyles) {
      //   if (!timelineData || !chartMainStyles) return
      //   // this._buildMondaysData(timelineData);
      //   // this.computeScatterChartRowsWithMondays(timelineData);
      //   // return

      //   // google.charts.load('current', {'packages':['corechart', 'calendar', 'scatter']});
      //   // google.charts.setOnLoadCallback(() => {

      //   //   let data, options;
      //   //   // ({ data, options } = this.prepareTraditionalScatterChart());
      //   //   // var chart = new google.visualization.ScatterChart(this.$.scatter_chart_div);
      //   //   // chart.draw(data, options); 

      //   //   // ({ data, options } = this.prepareScatterChart());
      //   //   // var chart = new google.charts.Scatter(this.$.scatter_chart_div);
      //   //   // chart.draw(data, google.charts.Scatter.convertOptions(options));        

      //   //   // ({ data, options } = this.prepareCalendarChart());
      //   //   // var chart = new google.visualization.Calendar(this.$.calendar_chart_div);
      //   //   // chart.draw(data, options);        


      //   // });
      //   // this.drawChart();
      // }

      // prepareCalendarChart() {
      //   // https://developers.google.com/chart/interactive/docs/gallery/calendar
      //   let data = new google.visualization.DataTable();
      //   data.addColumn({ type: 'date', id: 'Date' });
      //   data.addColumn({ type: 'number', id: 'Time scale' });
      //   data.addColumn({ type: 'string', role: 'tooltip', id: 'Time' });

      //   data.addRows(this.computeCalendarChartRows(this.timelineData));

      //   let calendarDataColor, noDataColor, noDataBackgroundColor, calendarWidth, calendarWidthAdjustFactor;
      //   ({ calendarDataColor, noDataColor, noDataBackgroundColor, calendarWidth, calendarWidthAdjustFactor } = this.chartMainStyles);

      //   const cellSize = Math.round((calendarWidthAdjustFactor * calendarWidth - 20.3)/55.8);
      //   const calendarHeight = 1.1 * (17.9 * cellSize + 29.9);

      //   let options = {
      //     // title: "Dias da semana",
      //     // height: 350,
      //     // width: 1200,
      //     /*
      //     16 - 908 317
      //     15 - 860 297
      //     14 - 804 281
      //     09 - 521 191
      //     calendarWidth = 55.8*cellSize + 20.3
      //     cellSize = (calendarWidth - 20.3)/55.8 
      //     calendarHeight = 17.9*cellSize + 29.9
      //     */
      //     width: calendarWidth,
      //     height: calendarHeight,
      //     calendar: { cellSize: cellSize }, 
      //     legend: 'none',
      //     colorAxis: {minValue: 0, colors: [calendarDataColor, calendarDataColor]},
      //     noDataPattern: {
      //       backgroundColor: noDataBackgroundColor,
      //       color: noDataColor
      //     }          
      //   };

      //   return { data, options };
      // }

      // prepareScatterChart() {
      //   // https://developers.google.com/chart/interactive/docs/gallery/scatterchart
      //   let data = new google.visualization.DataTable();
      //   data.addColumn({ type: 'date', id: 'Date' });
      //   data.addColumn({ type: 'timeofday', id: 'Time' });

      //   let chartWidth, dataColor;
      //   ({ chartWidth, dataColor } = this.chartMainStyles);

      //   let options = {
      //     chart: {
      //       title: 'Frequency',
      //       subtitle: 'and time'
      //     },
      //     colors:[dataColor], 
      //     // width: 300,         
      //     // height: 150,
      //     series: {
      //       0: {axis: 'time'},
      //       1: {axis: 'final grade'}
      //     },
      //     axes: {
      //       y: {
      //         'time': {label: 'Time'},
      //         'final grade': {label: 'Final Exam Grade'}
      //       }
      //     },
      //   };

      //   const rows = this.computeScatterChartRows(this.timelineData);
      //   console.log(rows);
      //   data.addRows(rows);


      //   return { data, options };
      // }

      prepareTraditionalScatterChart() {
        // https://developers.google.com/chart/interactive/docs/gallery/scatterchart
        let data = new google.visualization.DataTable();
        data.addColumn({ type: 'date', id: 'Date' });
        data.addColumn({type: 'string', role: 'annotation'});
        data.addColumn({type: 'string', role: 'annotationText'});
        data.addColumn({ type: 'timeofday', id: 'Time' });

        const rows = this.computeScatterChartRowsWithMondays(this.timelineData);
        console.log(rows);
        data.addRows(rows);

        let options = {
          // width: 800,
          // title: 'Freqüência e horários',
          // hAxis: {title: 'Age', minValue: 0, maxValue: 15},
          // vAxis: {title: 'Weight', minValue: 0, maxValue: 15},
          legend: 'none',
          annotations: {
              style: 'line'
          },
        };

        return { data, options };
      }

      // computeCalendarChartRows(timelineData) {
      //   const rows = this.timelineData
      //   .map((tdata, index) => [ 
      //     new Date(tdata.datetime), 
      //     this._timeToNumberScale(tdata.time),
      //     `${tdata.formattedDate} (${tdata.weekday}) ${tdata.time}`
      //   ]);
      //   // console.log(JSON.stringify(rows));
      //   return rows;
      // }

      // computeScatterChartRows(timelineData) {
      //   const rows = this.timelineData
      //     .map((tdata, index) => [ 
      //       new Date(tdata.datetime), 
      //       this._timeOfDay(tdata.datetime)
      //       // `${tdata.formattedDate} (${tdata.weekday}) ${tdata.time}`
      //     ]);



      //   console.log(JSON.stringify(rows));
      //   return rows;
      // }

      computeScatterChartRowsWithMondays(timelineData) {
        const mondays = this._buildMondaysData(timelineData);
        const mondaysRows = mondays.map((mondayDate) => [ mondayDate, '', 'monday', null ]);
        console.log(mondaysRows);
        const rows = this.timelineData
          .map((tdata, index) => [ 
            new Date(tdata.datetime),
            null, null, 
            this._timeOfDay(tdata.datetime)
          ]);
        console.log(rows);

        const allRows = rows.concat(mondaysRows);
        console.log(allRows);
        return allRows;

      }

      _buildMondaysData(timelineData) {
        const todayTimezoneDiff = new Date().getTimezoneOffset();
        return timelineData.map((tdata) => {
          const datetime = tdata.datetime;
          let timezoneDiff = new Date(datetime).getTimezoneOffset();
          let timezoneCorrection = (timezoneDiff - todayTimezoneDiff)*60*1000;
          const mondayBefore = getMonday(datetime); 
          const mondayBeforeCorrected = new Date(mondayBefore.getTime() + timezoneCorrection)
          return mondayBeforeCorrected;
        });
        
        //old method: build all mondays between dates - too many lines.
        const firstDay = timelineData[0].datetime;
        const firstMonday = getMonday(firstDay); 
        // console.log(firstDay, firstMonday)

        const lastDay = timelineData[timelineData.length-1].datetime;
        const lastDayNextWeek = new Date(lastDay.getTime() + 6*24*60*60*1000);
        const lastMonday = getMonday(lastDayNextWeek); //(lastDay) 
        // console.log(lastDay, lastMonday)

        let n = firstMonday.getTime();
        let mondays = [];
        while (n <= lastMonday.getTime()) {
          let timezoneDiff = new Date(n).getTimezoneOffset();
          let timezoneCorrection = (timezoneDiff - todayTimezoneDiff)*60*1000;
          // console.log(timezoneDiffInMillis);
          mondays.push(new Date(n + timezoneCorrection));
          n += 7*24*60*60*1000;          
        }

        // console.log(mondays)
        return mondays;

        function getMonday(d) {
        // https://stackoverflow.com/questions/4156434/javascript-get-the-first-day-of-the-week-from-current-date
          d = new Date(d);
          var day = d.getDay(),
              diff = d.getDate() - day + (day == 0 ? -6:1); // adjust when day is sunday
          return new Date(d.setDate(diff));
        }
      }

      _toDateTime(date) {
        return new Date(date);
      }

      _getDate(date) {
        if (!date) return;
        //https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/DateTimeFormat
        // var options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
        var options = { day: '2-digit', month: '2-digit', year: 'numeric' };
        const dateFormat = new Intl.DateTimeFormat(window.navigator.language, options);
        return dateFormat.format(date);        
      }

      _getTime(date) {
        return date.toLocaleString('pt-BR').substring(11,16).trim();
      }

      _getWeekDay(date) {
        //https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/DateTimeFormat
        const weekdayFormat = new Intl.DateTimeFormat(window.navigator.language, { 
          weekday: 'short', 
        });
        return weekdayFormat.format(date).toLocaleLowerCase();
      }

      _timeToNumberScale(time) {
        var hoursMinutes = time.split(/[.:]/);
        var hours = parseInt(hoursMinutes[0], 10);
        var minutes = hoursMinutes[1] ? parseInt(hoursMinutes[1], 10) : 0;
        // return parseFloat(`${hours}.${minutes}`);        
        return hours + minutes / 60;        
      }

      _timeOfDay(datetime) {
        //timeOfDay needs timezone correction (bug!)
        const plusTimezoneDate = addTimezone(datetime);

        // console.log(plusTimezoneDate, time);
        const time = this._getTime(plusTimezoneDate);

        //now format time already corrected with timezone
        var hoursMinutes = time.split(/[.:]/);
        var hours = parseInt(hoursMinutes[0], 10);
        var minutes = hoursMinutes[1] ? parseInt(hoursMinutes[1], 10) : 0;
        console.log([ hours, minutes, 0 ])
        return [ hours, minutes, 0 ];

        function addTimezone(datetime) {
          const d = new Date(datetime);
          const timezone = d.getTimezoneOffset();
          return new Date(d.getTime() + timezone * 60 * 1000);
        }
      }

      _formattedDate(date) {
        if (!date) return;
        const lang = window.Intl || 'en';
        //https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/DateTimeFormat
        const textDateFormat = new Intl.DateTimeFormat(lang, { 
          year: 'numeric',
          month: 'long', 
          day: 'numeric', 
        });

        return textDateFormat.format(date);
      }

      _sortDates(a, b) {
        return new Date(a) - new Date(b);
      }

      jsonStringify(obj) {
        return JSON.stringify(obj, null, 2);
      }



    }

    window.customElements.define(ATimeline.is, ATimeline);
  </script>
</dom-module>
